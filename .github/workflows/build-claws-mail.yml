name: Build Claws Mail Bundled Binary for Void

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: alpine:edge

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build tools and ICU
        run: |
          apk update
          apk add --no-cache \
            bash build-base curl tar \
            icu-libs icu-dev
          # Verify ICU libraries are installed
          ls -l /usr/lib/libicu*.so || { echo "ICU libraries not found"; exit 1; }

      - name: Install Claws Mail dependencies
        run: |
          apk add --no-cache \
            git wget pkgconf \
            musl-dev gtk+3.0-dev fuse \
            libetpan-dev gnutls-dev gpgme-dev enchant2-dev \
            poppler-dev libcanberra-dev libnotify-dev perl-dev \
            python3-dev libical-dev libarchive-dev openldap-dev \
            db-dev libx11-dev libsm-dev libsoup-dev \
            gumbo-parser-dev libsecret-dev json-glib-dev \
            ghostscript spamassassin appstream-glib \
            linux-headers glib-dev \
            webkit2gtk-4.1-dev qt5-qtbase-dev
          # If webkit2gtk-4.1-dev or qt5-qtbase-dev are unavailable in edge, fetch manually
          if ! apk info webkit2gtk-4.1-dev >/dev/null 2>&1; then
            wget -q -O webkit2gtk-4.1-dev.apk "https://dl-cdn.alpinelinux.org/alpine/edge/community/x86_64/webkit2gtk-4.1-dev-2.46.4-r0.apk"
            apk add --allow-untrusted webkit2gtk-4.1-dev.apk
            rm webkit2gtk-4.1-dev.apk
          fi
          if ! apk info qt5-qtbase-dev >/dev/null 2>&1; then
            wget -q -O qt5-qtbase-dev.apk "https://dl-cdn.alpinelinux.org/alpine/edge/community/x86_64/qt5-qtbase-dev-5.15.10_git20230714-r3.apk"
            apk add --allow-untrusted qt5-qtbase-dev.apk
            rm qt5-qtbase-dev.apk
          fi

      - name: Download Claws Mail source
        run: |
          mkdir -p ~/claws-mail-build
          cd ~/claws-mail-build
          wget "https://www.claws-mail.org/download.php?file=releases/claws-mail-4.3.0.tar.xz" -O claws-mail-4.3.0.tar.xz
          tar -xf claws-mail-4.3.0.tar.xz

      - name: Configure Claws Mail with all plugins
        run: |
          cd ~/claws-mail-build/claws-mail-4.3.0
          ./configure \
            --prefix=/usr \
            --enable-gtk3 --enable-libetpan --enable-gnutls --enable-pgp-core \
            --enable-pgp-inline --enable-pgp-mime --enable-enchant --enable-poppler \
            --enable-canberra --enable-notify --enable-perl --enable-python \
            --enable-vcalendar --enable-ldap \
            --enable-dillo --enable-fancy --enable-rssyl --enable-spamassassin \
            --enable-bogofilter --enable-notification --enable-pdf-viewer \
            --enable-spam-report --enable-address-keeper --enable-acpi-notifier \
            --enable-maildir --enable-newmail --enable-managesieve \
          || { echo "Configuration failed, check config.log"; cat config.log; exit 1; }
          # Log enabled features
          grep "yes" config.log || echo "No features explicitly enabled"

      - name: Build Claws Mail
        run: |
          cd ~/claws-mail-build/claws-mail-4.3.0
          make -j$(nproc) || { echo "Build failed"; exit 1; }

      - name: Install Claws Mail to a staging directory
        run: |
          cd ~/claws-mail-build/claws-mail-4.3.0
          mkdir -p ~/claws-mail-install/usr
          make install DESTDIR=~/claws-mail-install || { echo "Installation failed"; exit 1; }

      - name: Bundle all shared library dependencies
        run: |
          cd ~/claws-mail-install
          # Copy the binary
          cp ~/claws-mail-build/claws-mail-4.3.0/src/claws-mail usr/bin/
          # Find and copy all shared libraries
          ldd usr/bin/claws-mail | grep -o '/[^ ]*\.so[^ ]*' | sort -u | while read lib; do
            cp -v "$lib" usr/lib/ || { echo "Warning: $lib not found, may need manual inclusion"; continue; }
          done
          # Include additional common libraries (e.g., for plugins)
          for lib in /usr/lib/lib*.so*; do
            cp -v "$lib" usr/lib/ || true
          done
          # Strip binaries to reduce size (optional)
          strip usr/bin/claws-mail usr/lib/*.so* 2>/dev/null || true

      - name: Create tarball with binary and libraries
        run: |
          cd ~/claws-mail-install
          tar -czf ~/claws-mail-4.3.0-void-bundled.tar.gz .

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: claws-mail-void-bundled
          path: ~/claws-mail-4.3.0-void-bundled.tar.gz

      - name: Display SHA256 checksum
        run: |
          sha256sum ~/claws-mail-4.3.0-void-bundled.tar.gz
